<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>World Map + Live Population Counter (Cozy Edition)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1220; --card:#161a2e; --ink:#e8ecf8; --muted:#9aa3c9; --accent:#9ad7ff; }
    *{box-sizing:border-box}
    html,body{
      height:100%;margin:0;
      background:radial-gradient(1200px 800px at 20% 10%, #151a33 0%, #0f1220 55%, #0b0e1a 100%);
      color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial
    }
    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
    header{padding:20px 24px;display:flex;gap:14px;align-items:baseline}
    header h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(20px,2.6vw,28px)}
    .tag{
      padding:4px 10px;border-radius:999px;
      background:linear-gradient(90deg,rgba(154,215,255,.15),rgba(229,186,255,.15));
      color:var(--accent);font-weight:700;font-size:12px;border:1px solid rgba(154,215,255,.25)
    }
    .card{
      max-width:1100px;margin:0 auto;background:#161a2e;
      border:1px solid rgba(255,255,255,.06);border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);overflow:clip;position:relative
    }
    .mapPane{position:relative;min-height:520px}
    #map{width:100%;height:100%}
    .hud{
      position:absolute; inset:16px 16px auto auto;
      background:rgba(17,21,42,.7); backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px 14px;
      text-align:right; box-shadow:0 6px 24px rgba(0,0,0,.35)
    }
    .big{font-variant-numeric:tabular-nums;font-weight:800;font-size:clamp(28px,5vw,44px);letter-spacing:.5px}
    .sub{color:var(--muted);font-size:12px}

    /* bottom-center stats */
    .statsBar{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:12px; display:flex; gap:16px; align-items:center;
      background:rgba(17,21,42,.75); border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px); padding:10px 14px; border-radius:999px;
      font-variant-numeric: tabular-nums; box-shadow:0 6px 24px rgba(0,0,0,.35)
    }
    .pill{padding:4px 10px; border-radius:999px; background:rgba(255,255,255,.06); color:var(--ink); font-size:12px}
    .sep{opacity:.25}

    /* tooltip */
    .tooltip{
      position:absolute; pointer-events:none; z-index:5; opacity:0;
      transform: translate(-50%, -120%);
      background: rgba(17,21,42,.9); color: var(--ink);
      padding: 8px 10px; border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 28px rgba(0,0,0,.45);
      white-space: nowrap; font-size: 12px;
    }
    .tooltip .title{font-weight:700}
    .tooltip .muted{color:var(--muted)}

    .footer{
      padding:14px 18px;display:flex;gap:16px;flex-wrap:wrap;
      align-items:center;justify-content:space-between;
      border-top:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00))
    }
    .badge,.hint{color:var(--muted);font-size:12px}

    .geo{fill:#1b2140;stroke:rgba(255,255,255,.08);stroke-width:.5;cursor:pointer}
    .geo:hover{fill:#232a55}
    .ocean{fill:#101636;cursor:pointer}
    .ocean:hover{fill:#12204a}
    .pin-outline{stroke:#9ad7ff; stroke-width:1.5; fill:none; pointer-events:none}
  </style>
</head>
<body>
<div class="wrap">
  <header><h1>Global Cozy Index: <span class="tag">Population Clock</span></h1></header>

  <main class="card">
    <section class="mapPane">
      <svg id="map" viewBox="0 0 1100 520" preserveAspectRatio="xMidYMid meet" aria-label="World map"></svg>

      <!-- top-right live population -->
      <aside class="hud">
        <div class="big" id="popNum">8,200,000,000</div>
        <div class="sub" id="asOfText">as of ‚Ä¶</div>
      </aside>

      <!-- bottom-center live stats -->
      <div class="statsBar" id="statsBar" role="status" aria-live="polite">
        <span class="pill" id="elapsedPill">‚è± 0:00</span>
        <span class="sep">‚Ä¢</span>
        <span class="pill" id="birthsPill">üë∂ Births: 0</span>
        <span class="pill" id="deathsPill">üïä Deaths: 0</span>
        <span class="pill" id="netPill">‚ûï Net: +0</span>
        <span class="sep">‚Ä¢</span>
        <span class="pill" id="ratesPill">Rates: +2.2/s (4.2‚àí2.0)</span>
      </div>

      <!-- hover/pinned tooltip -->
      <div class="tooltip" id="tooltip"><span class="title">‚Ä¶</span></div>
    </section>

    <footer class="footer">
      <div class="badge">Live estimates; educational/approximate.</div>
      <div class="hint">Baseline from UN WPP 2024; rates ~2025 US Census brief.</div>
    </footer>
  </main>
</div>

<!-- UMD build -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script>
(async function(){
  /* ---------- Population model ---------- */
  const BASELINE_ISO = "2025-10-25T01:00:00Z"; // adjust if you want to snap to a different moment
  const BASELINE_POPULATION = 8253276238;
  const BIRTHS_PER_SEC = 4.2;
  const DEATHS_PER_SEC = 2.0;
  const NET_PER_SEC = BIRTHS_PER_SEC - DEATHS_PER_SEC;

  // lightweight 2025 estimates (extend as you like)
  const POP_2025 = {
    "China": 1413000000, "India": 1429000000, "United States of America": 342000000,
    "Indonesia": 282000000, "Pakistan": 246000000, "Nigeria": 229000000, "Brazil": 217000000,
    "Bangladesh": 173000000, "Russian Federation": 145000000, "Mexico": 132000000, "Japan": 123000000,
    "Ethiopia": 132000000, "Philippines": 118000000, "Egypt": 113000000, "Vietnam": 100000000,
    "DR Congo": 111000000, "Turkey": 87900000, "Iran": 89100000, "Germany": 84000000, "Thailand": 71900000,
    "United Kingdom": 69200000, "France": 68300000, "Italy": 58800000, "South Africa": 61700000,
    "Tanzania": 70000000, "Kenya": 56100000, "Spain": 48200000, "Argentina": 46300000, "Colombia": 52500000,
    "Canada": 41700000, "Ukraine": 37200000, "Poland": 38200000, "Saudi Arabia": 36000000, "Australia": 26800000,
    "Morocco": 38100000, "Iraq": 46000000, "Afghanistan": 42000000, "Algeria": 45600000, "Sudan": 49000000,
    "Myanmar": 54700000, "South Korea": 51200000, "Nepal": 30700000, "Peru": 34100000, "Malaysia": 34600000,
    "Ghana": 34000000, "Uzbekistan": 35200000, "Yemen": 35000000, "Mozambique": 35000000, "Madagascar": 31600000,
    "Angola": 36500000, "Cameroon": 29000000, "C√¥te d‚ÄôIvoire": 30000000, "Niger": 28000000, "Netherlands": 17800000,
    "Chile": 19700000, "Romania": 19000000, "Kazakhstan": 20000000, "Greece": 10300000, "Portugal": 10300000,
    "Sweden": 10500000, "Norway": 5500000, "Denmark": 6000000, "Finland": 5600000, "New Zealand": 5300000,
    "Czechia": 10700000, "Belgium": 11800000, "Switzerland": 9000000, "Austria": 9100000, "Israel": 9900000,
    "United Arab Emirates": 10000000, "Qatar": 3000000, "Singapore": 5900000, "Hong Kong": 7400000, "Taiwan": 23200000,
    "Ireland": 5600000, "Hungary": 9600000, "Bulgaria": 6600000, "Serbia": 6600000, "Croatia": 3900000,
    "Slovakia": 5400000, "Lithuania": 2800000, "Latvia": 1800000, "Estonia": 1300000, "Iceland": 400000,
    "Luxembourg": 660000, "Malta": 560000
  };
  const ALIAS = {
    "Congo, Dem. Rep.": "DR Congo",
    "Congo, Democratic Republic of the": "DR Congo",
    "Czech Republic": "Czechia",
    "Korea, South": "South Korea",
    "Korea, Rep.": "South Korea",
    "United States": "United States of America",
    "Cote d'Ivoire": "C√¥te d‚ÄôIvoire"
  };

  /* ---------- DOM ---------- */
  const popNum = document.getElementById("popNum");
  const asOfText = document.getElementById("asOfText");
  const elapsedPill = document.getElementById("elapsedPill");
  const birthsPill = document.getElementById("birthsPill");
  const deathsPill = document.getElementById("deathsPill");
  const netPill = document.getElementById("netPill");
  const ratesPill = document.getElementById("ratesPill");
  const tooltip = document.getElementById("tooltip");
  const mapPane = document.querySelector(".mapPane");

  const baselineMs = Date.parse(BASELINE_ISO);
  const pageStartMs = Date.now();

  asOfText.textContent = "as of " + new Date(BASELINE_ISO).toLocaleString(undefined,{dateStyle:"medium", timeStyle:"short"});
  ratesPill.textContent = `Rates: +${NET_PER_SEC.toFixed(1)}/s (${BIRTHS_PER_SEC.toFixed(1)}‚àí${DEATHS_PER_SEC.toFixed(1)})`;

  function fmtInt(n){ return new Intl.NumberFormat(undefined,{maximumFractionDigits:0}).format(Math.floor(n)); }
  function fmtShort(n){ if (n>=1e9) return (n/1e9).toFixed(n>=10e9?0:1)+"B"; if (n>=1e6) return (n/1e6).toFixed(n>=10e6?0:1)+"M"; return fmtInt(n); }
  function fmtElapsed(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${m}:${String(r).padStart(2,'0')}`; }

  function tick(){
    const now = Date.now();
    const current = BASELINE_POPULATION + ((now-baselineMs)/1000)*NET_PER_SEC;
    popNum.textContent = fmtInt(current);

    const elapsedMs = now - pageStartMs;
    const secs = elapsedMs/1000;
    const births = secs * BIRTHS_PER_SEC;
    const deaths = secs * DEATHS_PER_SEC;
    const net = births - deaths;

    elapsedPill.textContent = `‚è± ${fmtElapsed(elapsedMs)}`;
    birthsPill.textContent = `üë∂ Births: ${fmtInt(births)}`;
    deathsPill.textContent = `üïä Deaths: ${fmtInt(deaths)}`;
    netPill.textContent = `‚ûï Net: ${net>=0?'+':''}${fmtInt(net)}`;
  }
  tick(); setInterval(tick, 100);

  /* ---------- Map (GeoJSON with names, resilient loader) ---------- */
  const GEO_URLS = [
    // If you self-host a copy (best): add it to your repo as /assets/world.geojson,
    // then uncomment the next line and move it to the top of the list.
    // "/assets/world.geojson",

    // GitHub mirrors (served as text/plain but parseable)
    "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson",
    "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json",
    "https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson",

    // Keep geojson.xyz last due to occasional 403s
    "https://geojson.xyz/world/ne_110m_admin_0_countries.geojson"
  ];

  async function fetchJsonFrom(urls){
    let lastErr;
    for (const u of urls){
      try{
        const r = await fetch(u, { cache: "force-cache" });
        if (!r.ok) { console.warn("Geo fetch failed:", u, r.status); lastErr = new Error(`HTTP ${r.status}`); continue; }
        const txt = await r.text();
        try {
          const data = JSON.parse(txt);
          console.log("Geo loaded from:", u);
          return data;
        } catch (e) {
          console.warn("Parse failed from:", u, e.message);
          lastErr = e; continue;
        }
      } catch(e){
        console.warn("Request error from:", u, e.message);
        lastErr = e; continue;
      }
    }
    throw lastErr || new Error("Failed to fetch world GeoJSON from all mirrors.");
  }

  const svg = d3.select("#map");
  const width = 1100, height = 520;
  const projection = d3.geoNaturalEarth1().fitSize([width, height], {type:"Sphere"});
  const path = d3.geoPath(projection);

  const oceanPath = svg.append("path")
    .attr("d", path({type:"Sphere"}))
    .attr("class","ocean")
    .attr("data-name","üåä Oceans");

  const pinOutline = svg.append("path").attr("class", "pin-outline").style("display","none");

  try{
    const world = await fetchJsonFrom(GEO_URLS);
    // Harmonize property names across sources
    const features = (world.features || []).map(f=>{
      const p = f.properties || {};
      const name = p.name || p.ADMIN || p.ADMIN_NAME || p.NAME_EN || p.Country || "Unknown";
      return Object.assign({}, f, { properties: Object.assign({}, p, { __name: name }) });
    });

    svg.append("g")
      .selectAll("path")
      .data(features)
      .join("path")
      .attr("class","geo")
      .attr("d", path)
      .attr("data-name", d=>d.properties.__name);

    /* ----- tooltip + pin ----- */
    let pinned = null;
    const tooltipEl = document.getElementById("tooltip");
    const ttTitle = document.createElement("div"); ttTitle.className="title";
    const ttLine  = document.createElement("div"); ttLine.className="muted";
    tooltipEl.innerHTML=""; tooltipEl.appendChild(ttTitle); tooltipEl.appendChild(ttLine);

    function lookupPop(name){ const canon = ALIAS[name] || name; return POP_2025[canon]; }

    function showTooltip(name, x, y){
      const p = lookupPop(name);
      ttTitle.textContent = name;
      ttLine.textContent = (name === "üåä Oceans")
        ? "No population"
        : (p ? `2025 est: ${fmtShort(p)} (${new Intl.NumberFormat().format(p)})` : "2025 est: (no estimate yet)");
      tooltipEl.style.left = x + "px";
      tooltipEl.style.top  = y + "px";
      tooltipEl.style.opacity = 1;
    }
    const hideTooltip = ()=>{ if (!pinned) tooltipEl.style.opacity = 0; };

    function clampToPane(ev){
      const rect = mapPane.getBoundingClientRect();
      const x = Math.max(rect.left+20, Math.min(ev.clientX, rect.right-20));
      const y = Math.max(rect.top+20, Math.min(ev.clientY, rect.bottom-20));
      return { x: x - rect.left, y: y - rect.top };
    }

    function handleMove(ev){
      if (pinned) return;
      const t = ev.target;
      let name = null;
      if (t.classList.contains("geo") || t.classList.contains("ocean")){
        name = t.getAttribute("data-name") || (t.classList.contains("ocean") ? "üåä Oceans" : null);
      }
      const {x,y} = clampToPane(ev);
      if (name) showTooltip(name, x, y); else hideTooltip();
    }

    function setPinOutline(dOrSphere){
      if (!dOrSphere){ pinOutline.style("display","none"); return; }
      pinOutline.attr("d", path(dOrSphere)).style("display","block");
    }

    function handleClick(ev){
      const t = ev.target;
      const {x,y} = clampToPane(ev);
      if (!(t.classList.contains("geo") || t.classList.contains("ocean"))){
        pinned = null; hideTooltip(); setPinOutline(null); return;
      }
      const name = t.getAttribute("data-name") || (t.classList.contains("ocean") ? "üåä Oceans" : null);
      if (!name) return;

      if (pinned && pinned.name === name){
        pinned = null; hideTooltip(); setPinOutline(null);
      } else {
        pinned = { name, x, y };
        showTooltip(name, x, y);
        if (name === "üåä Oceans"){ setPinOutline({type:"Sphere"}); }
        else { setPinOutline(t.__data__); }
      }
    }

    window.addEventListener("keydown", e=>{ if (e.key === "Escape"){ pinned = null; hideTooltip(); setPinOutline(null); }});
    svg.on("mousemove", handleMove);
    svg.on("mouseleave", hideTooltip);
    svg.on("click", handleClick);
    oceanPath.on("mousemove", handleMove);
    oceanPath.on("mouseleave", hideTooltip);
    oceanPath.on("click", handleClick);

  } catch (e){
    console.error(e);
    const warn = document.createElement("div");
    warn.style.position="absolute"; warn.style.left="16px"; warn.style.bottom="16px";
    warn.style.padding="10px 12px"; warn.style.background="rgba(255,75,75,.12)";
    warn.style.border="1px solid rgba(255,75,75,.4)"; warn.style.borderRadius="10px"; warn.style.color="#ffbdbd";
    warn.textContent="Could not load world GeoJSON (CORS/network). Consider self-hosting /assets/world.geojson.";
    document.querySelector(".mapPane").appendChild(warn);
  }
})();
</script>
</body>
</html>
